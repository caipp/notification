# Copyright 2018 The OpenPitrix Authors. All rights reserved.
# Use of this source code is governed by a Apache license
# that can be found in the LICENSE file.

version: '3'

services:
  # notification mysql db
  notification-db:
    image: "mysql:8.0.11"
    environment:
    - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
    volumes:
    - ${DATA_PATH}/mysql:/var/lib/mysql
    - ./pkg/db/ddl:/docker-entrypoint-initdb.d
    command: --lower_case_table_names=0 --max_allowed_packet=10485760 --max_connections=256
    ports:
    - "13306:3306" # for unit-test & debug
    container_name: "notification-db"
    logging:
      driver: "json-file"
      options:
        max-size: ${NOTIFICATION_LOG_MAX_SIZE}
        max-file: ${NOTIFICATION_LOG_MAX_FILE}

  # notification redis
  notification-redis:
    image: "redis:5.0.5-alpine"
    volumes:
    - ${DATA_PATH}/redis:/data
    command: redis-server
    ports:
    - "6379:6379"
    container_name: "notification-redis"

  # notification etcd
  notification-etcd:
    image: "quay.io/coreos/etcd:v3.2.18"
    command: etcd --data-dir /data --listen-client-urls http://0.0.0.0:2379 --advertise-client-urls http://notification-etcd:2379 --max-snapshots 5 --max-wals 5 --auto-compaction-retention=168
    volumes:
    - ${DATA_PATH}/etcd:/data
    ports:
    - "12379:2379" # for unit-test & debug
    container_name: "notification-etcd"
    logging:
      driver: "json-file"
      options:
        max-size: ${NOTIFICATION_LOG_MAX_SIZE}
        max-file: ${NOTIFICATION_LOG_MAX_FILE}

  # notification service
  notification-manager:
    #build: .
    image: "notification:latest"
    #image: "kubespheredev/notification:v0.2.0"
    command: "notification"
    links:
    - notification-db:notification-db
    - notification-etcd:notification-etcd
    depends_on:
    - notification-notification-db-ctrl
    - notification-etcd
    container_name: "notification-manager"
    environment:
    - NOTIFICATION_LOG_LEVEL=${NOTIFICATION_LOG_LEVEL}
    - NOTIFICATION_GRPC_SHOW_ERROR_CAUSE=${NOTIFICATION_GRPC_SHOW_ERROR_CAUSE}
    - NOTIFICATION_MYSQL_DATABASE=notification
    - NOTIFICATION_MYSQL_LOG_MODE=false
    - NOTIFICATION_LOG_LEVEL=debug
    - NOTIFICATION_APP_MAX_WORKING_NOTIFICATIONS=5
    - NOTIFICATION_APP_MAX_WORKING_TASKS=5
    - NOTIFICATION_EMAIL_PROTOCOL=SMTP
    - NOTIFICATION_EMAIL_EMAIL_HOST=mail.example.com
    - NOTIFICATION_EMAIL_PORT=25
    - NOTIFICATION_EMAIL_DISPLAY_SENDER=KubeSphere
    - NOTIFICATION_EMAIL_EMAIL=admin@example.com
    - NOTIFICATION_EMAIL_PASSWORD=password
    - NOTIFICATION_EMAIL_SSL_ENABLE=False
    logging:
      driver: "json-file"
      options:
        max-size: ${NOTIFICATION_LOG_MAX_SIZE}
        max-file: ${NOTIFICATION_LOG_MAX_FILE}
    ports:
    - "9200:9200"
    - "9201:9201"
  notification-notification-db-ctrl:
    image: dhoer/flyway:5.1.4-mysql-8.0.11-alpine
    command: -url=jdbc:mysql://notification-db/notification -user=root -password=${MYSQL_ROOT_PASSWORD} -validateOnMigrate=false migrate
    volumes:
    - ./pkg/db/schema/notification:/flyway/sql
    links:
    - notification-db:notification-db
    depends_on:
    - notification-db
    container_name: "notification-notification-db-ctrl"
